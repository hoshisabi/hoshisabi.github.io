<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Data Viewer with Filters and Pagination</title>
    <script src="https://unpkg.com/htmx.org@1.6.1"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .pagination {
            margin-top: 10px;
            text-align: center;
        }
        .pagination button {
            margin: 0 5px;
            cursor: pointer;
            padding: 5px 10px;
        }
    </style>
</head>
<body>

<h1>CSV Data Viewer with Filters and Pagination</h1>

<div>
    <label for="runtime-filter">Runtime (hours):</label>
    <input type="number" id="runtime-filter" name="runtime-filter">
    <label for="tier-filter">Tier:</label>
    <input type="number" id="tier-filter" name="tier-filter">
    <label for="campaign-filter">Campaign:</label>
    <input type="text" id="campaign-filter" name="campaign-filter">
    <button id="apply-filters">Apply Filters</button>
</div>

<button hx-get="adventures.csv" hx-trigger="click" hx-target="#content" hx-ext="csv">Load Data</button>

<div id="content">
    <!-- The CSV data will be displayed here -->
</div>

<div class="pagination" id="pagination">
    <!-- Pagination buttons will be inserted here -->
</div>

<script>
    let currentPage = 1;
    const rowsPerPage = 50;
    let filteredData = [];

    document.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'content') {
            Papa.parse(event.detail.xhr.responseText, {
                header: true,
                dynamicTyping: true,
                complete: function(results) {
                    filteredData = results.data;
                    applyFiltersAndPagination();
                }
            });
        }
    });

    document.getElementById('apply-filters').addEventListener('click', function() {
        applyFiltersAndPagination();
    });

    function applyFiltersAndPagination() {
        const runtimeFilter = document.getElementById('runtime-filter').value;
        const tierFilter = document.getElementById('tier-filter').value;
        const campaignFilter = document.getElementById('campaign-filter').value.toLowerCase().trim();

        filteredData = filterData(runtimeFilter, tierFilter, campaignFilter);
        renderTableAndPagination();
    }

    function filterData(runtimeFilter, tierFilter, campaignFilter) {
        return filteredData.filter(item => {
            return (runtimeFilter === '' || item.Runtime == runtimeFilter) &&
                (tierFilter === '' || item.Tier == tierFilter) &&
                (campaignFilter === '' || item.Season.toLowerCase().includes(campaignFilter));
        });
    }

    function renderTableAndPagination() {
        const startIndex = (currentPage - 1) * rowsPerPage;
        const endIndex = startIndex + rowsPerPage;
        const paginatedData = filteredData.slice(startIndex, endIndex);

        let table = '<table>';
        table += '<tr><th>Campaign</th><th>Code</th><th>Title</th><th>Hours</th><th>Tiers</th><th>URL</th></tr>';
        paginatedData.forEach(item => {
            table += `<tr>
                    <td>${item.Season}</td>
                    <td>${item.Code}</td>
                    <td>${item.Title}</td>
                    <td>${item.Runtime}</td>
                    <td>${item.Tier}</td>
                    <td><a href="${item.URL}" target="_blank">Link</a></td>
                  </tr>`;
        });
        table += '</table>';
        document.getElementById('content').innerHTML = table;

        renderPagination();
    }

    function renderPagination() {
        const totalPages = Math.ceil(filteredData.length / rowsPerPage);
        let paginationButtons = '';
        for (let i = 1; i <= totalPages; i++) {
            paginationButtons += `<button hx-get="adventures.csv?_page=${i}" hx-trigger="click" hx-target="#content" hx-ext="csv">${i}</button>`;
        }
        document.getElementById('pagination').innerHTML = paginationButtons;
    }

    // Load first 50 rows by default
    document.addEventListener('DOMContentLoaded', function() {
        fetch(`adventures.csv?_page=1`)
            .then(response => response.text())
            .then(csv => {
                Papa.parse(csv, {
                    header: true,
                    dynamicTyping: true,
                    complete: function(results) {
                        filteredData = results.data;
                        renderTableAndPagination();
                    }
                });
            });
    });
</script>

</body>
</html>
